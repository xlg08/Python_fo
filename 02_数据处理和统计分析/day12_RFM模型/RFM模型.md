# RFM模型

> 会员价值度用来评估用户的价值情况，是区分会员价值的重要模型和参考依据，也是衡量不同营销效果的关键指标。

>  价值度模型一般基于交易行为产生，衡量的是有实体转化价值的行为。常用的价值度模型是RFM

> RFM模型是根据会员
>
> ​	最近一次购买时间	R（Recency）
>
> ​	购买频率	F（Frequency）
>
> ​	购买金额	M（Monetary）	计算得出RFM得分
>
> ​	通过这3个维度来评估客户的订单活跃价值，常用来做客户分群或价值区分
>
> RFM模型基于一个固定时间点来做模型分析，不同时间计算的的RFM结果可能不一样

## 用户类别

![1744506575544](C:\Users\LG\AppData\Roaming\Typora\typora-user-images\1744506575544.png)

## RFM模型的基本实现过程

> ①设置要做计算时的截止时间节点（例如2017-5-30），用来做基于该时间的数据选取和计算。
>
> ​	>> 类似于生日，为一个固定时间节点，年龄一般都从生日向前推到出生
>
> ②在会员数据库中，以今天为时间界限向前推固定周期（例如1年），得到包含每个会员的会员ID、订单时间、订单金额的原始数据集。一个会员可能会产生多条订单记录。
>
> ③ 数据预计算。
>
> ​	R：最近截止时间 - 上一次购买时间
>
> ​		设置最大时间节点(一般为当前年的最后一天作为截止时间)截止时间 - 提交时间    （最大下单截止时间的数字）
>
> ​		从订单时间中找到各个会员距离截止时间节点最近的订单时间作为最近购买时间
>
> ​	F：聚合
>
> ​		以会员ID为维度统计每个用户的订单数量作为购买频率
>
> ​	M：将用户多个订单的订单金额求和得到总订单金额
>
> ​	由此得到R、F、M三个原始数据量。
>
> ​	本质上还有
>
> ​		1.处理数据空值。。当时的空值是什么？ 空值处理的方案
>
> ​		2.异常值如何处理！	极大值、极小值     处理方案
>
> ④ R、F、M分区。对于F和M变量来讲，值越大代表购买频率越高、订单金额越高；但对R来讲，值越小代表离截止时间节点越近，因此值越好。对R、F、M分别使用五分位（三分位也可以，分位数越多划分得越详细）法做数据分区。需要注意的是，对于R来讲需要倒过来划分，离截止时间越近的值划分越大。这样就得到每个用户的R、F、M三个变量的分位数值。
>
> ⑤ 将3个值组合或相加得到总的RFM得分。对于RFM总得分的计算有两种方式，一种是直接将3个值拼接到一起，例如RFM得分为312、333、132；另一种是直接将3个值相加求得一个新的汇总值，例如RFM得分为6、9、6。

## RFM划分思路

### 以某电商公司为例：

>R：例如：正常新用户注册1周内交易，7天是重要的值，日用品采购周期是1个月，30天是重要的值
>
>F：例如：1次购买，2次购买，3次购买，4~10次，10次以上
>
>M：例如：客单价300，热销单品价格240 等

### 常见的确定RFM划分区间的套路：

> 常见的确定RFM划分区间的套路：
>
> ​	业务实际判断
>
> ​	平均值或中位数
>
> ​	二八法则

### 在得到不同会员的RFM之后，根据步骤⑤产生的两种结果有两种应用思路

> 思路1：基于3个维度值做用户群体划分和解读，对用户的价值度做分析
>
> ​	①得分为212的会员往往购买频率较低，针对购买频率低的客户应定期发送促销活动邮件
>
> ​	②得分为321的会员虽然购买频率高但是订单金额低等，这些客户往往具有较高的购买黏性，可以考虑通过关联或搭配销售的方式提升订单金额。
>
>
>
> 思路2：基于RFM的汇总得分评估所有会员的价值度价值，并可以做价值度排名。
>
> ​	同时，该得分还可以作为输入维度与其他维度一起作为其他数据分析和挖掘模型的输入变量，为分析建模提供基础。

# 案例

## 背景介绍

### 用户价值细分是了解用户价值度的重要途径，针对交易数据分析的常用模型是RFM模型

### 业务对RFM的结果要求

> 对用户做分组
>
> 将每个组的用户特征概括和总结出来，便于后续精细化运营不同的客户群体，且根据不同群体做定制化或差异性的营销和关怀

### 规划目标将RFM的3个维度分别做3个区间的离散化

> 用户群体最大有3×3×3=27个
>
> 划分区间过多则不利于用户群体的拆分
>
> 区间过少则可能导致每个特征上的用户区分不显著

### 交付结果

>  给业务部门做运营的分析结果要导出为Excel文件，用于做后续分析和二次加工使用
>
> ​	A部分的输出是B部门的输入
>
> RFM的结果还会供其他模型的建模使用，RFM本身的结果可以作为新的局部性特征，因此数据的输出需要有本地文件和写数据库两种方式

### 数据说明

> 选择4年订单数据，从不同的年份对比不同时间下各个分组的绝对值变化情况，方便了解会员的波动
>
> 案例的输入源数据 sales.xlsx
>
> 程序输出RFM得分数据写入本地文件  sales_rfm_score.xlsx  和   MySQL 数据库 sales_rfm_score 表中

### 技术点

>  通过Python代码手动实现RFM模型，主要用到的库包括
>
> ​	Pandas 		Numpy
>
> ​	在结果展示时使用了	pyecharts	的	3D柱形图

## 案例数据

### 数据介绍

> 案例数据是某企业从2015年到2018年共4年的用户订单抽样数据，数据来源于销售系统
>
> 数据在Excel中包含5个sheet，前4个sheet以年份为单位存储为单个sheet中，最后一张会员等级表为用户的等级表

库：

![1744511695164](C:\Users\LG\AppData\Roaming\Typora\typora-user-images\1744511695164.png)

### 业务流程（业务分析）

![1744510535713](C:\Users\LG\AppData\Roaming\Typora\typora-user-images\1744510535713.png)

### 技术架构

![1744510609639](C:\Users\LG\AppData\Roaming\Typora\typora-user-images\1744510609639.png)

#### pandas技术

##### **TimedeltaProperties 对象**

###### 对象

> 在 Pandas 中，`TimedeltaProperties` 是专门用来操作 **时间差列（Timedelta）** 的一个“工具包”。
>
> 当有一列数据是时间差（比如 `3 days 05:30:00`、`2小时` 这种格式），Pandas 会通过 `dt` 访问器调用这个工具包，使得可以方便地提取时间差的各个部分（比如天数、小时、秒数等）。
>
>

###### 核心作用

> 它存在的意义：**把复杂的时间差数据拆解成具体的数值**，方便计算和分析。

###### **常见属性和方法**

> 假设有一个时间差列 `df["时间差"]`，通过 `df["时间差"].dt` 调用 `TimedeltaProperties` 后，可以这样操作：
>
> **1.提取时间差的组成部分**
>
> - **.days** → 获取时间差的 **总天数**（整数部分）
>
>   ```
>   # 示例：时间差是 "3天5小时30分"，输出 3
>   df["时间差"].dt.days
>   ```
>
> - **.seconds** → 获取时间差的 **剩余秒数**（扣除天数后的秒数）
>
>   ```
>   # 示例：时间差是 "3天5小时30分"，输出 5*3600 + 30*60 = 19800 秒
>   df["时间差"].dt.seconds0
>   ```
>
> - **.microseconds** → 获取时间差的 **微秒数**
>
> - **.nanoseconds** → 获取时间差的 **纳秒数**
>
> **2. 转换为总单位**
>
> - **.total_seconds()** → 获取时间差的 **总秒数**（包括天数的秒数）
>
>   ```
>   # 示例：时间差是 "3天5小时30分"，总秒数 = 3*86400 + 5*3600 + 30*60 = 284400
>   df["时间差"].dt.total_seconds()
>   ```

#### pyecharts技术

#####  faker 对象

###### 对象

> **Faker** 是一个专门用于生成虚拟测试数据的工具类。
>
> 目的是方便用户在快速绘制图表时，无需手动准备真实数据，即可进行演示、测试或教学。

###### **Faker 的主要功能**

>1. **内置常用虚拟数据**
>   `Faker` 预置了多种常见类型的模拟数据，例如：
>   - **地名**：省份、城市（如 `Faker.provinces`, `Faker.guangdong_city`）
>   - **数值**：随机数、金额（如 `Faker.values()`, `Faker.amount()`）
>   - **分类名称**：商品、浏览器类型（如 `Faker.products`, `Faker.browsers`）
>   - **时间序列**：日期（如 `Faker.date()`）
>2. **简化图表开发流程**
>   通过直接调用 `Faker` 的方法，可以快速生成符合 ECharts 图表要求的输入格式（如列表、键值对等），节省手动造数据的时间。

###### **示例**

> from pyecharts.charts import Bar
> from pyecharts.faker import Faker
> from pyecharts import options as opts
>
> #生成虚拟数据：x轴为商品名，y轴为随机数值
> x_data = Faker.products  # 例如 ["商品A", "商品B", "商品C", "商品D", "商品E"]
> y_data = Faker.values()  # 例如 [40, 90, 55, 80, 30]
>
> #绘制柱状图
> bar = (
>    	 Bar()
>    	 .add_xaxis(x_data)    .add_yaxis("销量", y_data)
>   	 .set_global_opts(title_opts=opts.TitleOpts(title="虚拟商品销量"))
> )
>
> bar.render("demo.html")  # 生成 HTML 文件并查看图表

###### **与其他 Faker 库的区别**

> - **python-faker 库**：一个独立的第三方库，功能更全面（生成姓名、地址、文本等），但需要额外安装。
> - **pyecharts.faker.Faker**：PyEcharts 内置的轻量级工具，专注于图表测试数据，无需额外安装。

###### 常用方法

![1744539621157](C:\Users\LG\AppData\Roaming\Typora\typora-user-images\1744539621157.png)

> 通过 `dir(Faker)` 可查看全部可用数据方法。利用这些数据，你可以快速测试折线图、饼图、地图等多种图表类型。

##### options 对象

###### 对象

>`options` 用于定义和配置图表的各种样式、组件和交互行为。
>
>提供了一系列类和方法，允许用户通过参数化方式精细控制图表的外观和功能。

###### 作用

>1. **图表标题**（`TitleOpts`）
>2. **坐标轴**（`AxisOpts`：如 X/Y 轴的标签、范围、刻度等）
>3. **图例**（`LegendOpts`）
>4. **工具箱**（`ToolboxOpts`：如保存图片、数据缩放等工具）
>5. **视觉映射**（`VisualMapOpts`：颜色、尺寸映射）
>6. **提示框**（`TooltipOpts`：鼠标悬停时的信息展示）
>7. **其他高级配置**（如动画、背景色等

###### 用法

> from pyecharts import options as opts
>
>
>
> #示例：创建一个折线图并配置标题、坐标轴
>
> chart = (
> ​	Line()
> ​		.add_xaxis([...])
> ​		.add_yaxis("系列名称", [...])
> ​		.set_global_opts(
> ​			title_opts=opts.TitleOpts(title="我的图表"),  # 标题配置
> ​			xaxis_opts=opts.AxisOpts(name="X轴"),        # X轴配置
> ​			yaxis_opts=opts.AxisOpts(name="Y轴"),        # Y轴配置
> ​			toolbox_opts=opts.ToolboxOpts()             # 显示默认工具箱
> ​		)
> ​	)

###### 结构

> `options` 模块包含多个子类，每个类对应一种配置项。例如：
>
> - `TitleOpts`: 图表标题
> - `AxisOpts`: 坐标轴
> - `LegendOpts`: 图例位置和样式
> - `TooltipOpts`: 提示框格式
> - `VisualMapOpts`: 颜色/尺寸映射规则






